name: CLI Release

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/conduit

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    defaults:
      run:
        working-directory: ./cli
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from commit hash
        id: version
        run: echo "VERSION=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Set up Go 1.24.3
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'

      - name: Verify Go version
        run: go version

      - name: Setup dependencies
        run: make setup

      - name: Create Psiphon config
        run: echo '${{ secrets.PSIPHON_CONFIG_JSON }}' > psiphon_config.json

      - name: Build all platforms with embedded config
        run: make build-all-embedded PSIPHON_CONFIG=psiphon_config.json VERSION=${{ steps.version.outputs.VERSION }}

      - name: Remove Psiphon config from dist
        run: rm -f psiphon_config.json internal/config/psiphon_config.json

      - name: Create checksums
        run: |
          cd dist
          sha256sum conduit-* > checksums.txt
          cat checksums.txt

      # Docker build and push (multi-arch)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-create Psiphon config for Docker build
        run: echo '${{ secrets.PSIPHON_CONFIG_JSON }}' > psiphon_config.json

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./cli
          file: ./cli/Dockerfile.embedded
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            PSIPHON_CONFIG=psiphon_config.json
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Remove Psiphon config
        run: rm -f psiphon_config.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Conduit CLI ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            cli/dist/conduit-linux-amd64
            cli/dist/conduit-linux-arm64
            cli/dist/conduit-darwin-amd64
            cli/dist/conduit-darwin-arm64
            cli/dist/conduit-windows-amd64.exe
            cli/dist/conduit-freebsd-amd64
            cli/dist/checksums.txt
          body: |
            ## Conduit CLI ${{ steps.version.outputs.VERSION }}

            Conduit is a volunteer-run proxy node that helps relay traffic for users in censored regions.

            ### Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x86_64 (amd64) | [conduit-linux-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/conduit-linux-amd64) |
            | Linux | ARM64 | [conduit-linux-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/conduit-linux-arm64) |
            | macOS | Intel (amd64) | [conduit-darwin-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/conduit-darwin-amd64) |
            | macOS | Apple Silicon (arm64) | [conduit-darwin-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/conduit-darwin-arm64) |
            | Windows | x86_64 (amd64) | [conduit-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/conduit-windows-amd64.exe) |
            | FreeBSD | x86_64 (amd64) | [conduit-freebsd-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/conduit-freebsd-amd64) |

            ### Quick Start

            ```bash
            # Download (Linux x86_64 example)
            curl -L -o conduit https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/conduit-linux-amd64
            chmod +x conduit

            # Run
            ./conduit start

            # Run with verbose output
            ./conduit start -v

            # Run with debug output
            ./conduit start -vv
            ```

            ### Docker

            ```bash
            # Pull from GitHub Container Registry
            docker pull ghcr.io/${{ github.repository }}/conduit:latest

            # Run with persistent data volume (recommended)
            docker run -d --name conduit \
              -v conduit-data:/home/conduit/data \
              --restart unless-stopped \
              ghcr.io/${{ github.repository }}/conduit:latest
            ```

            **Important:** Always use a persistent volume for the data directory. The Psiphon broker tracks proxy reputation by key - without persistence, you'll start fresh each time.

            ### Configuration Options

            | Option | Default | Description |
            |--------|---------|-------------|
            | `--max-clients, -m` | 50 | Maximum concurrent clients (1-1000) |
            | `--bandwidth, -b` | 40 | Total bandwidth limit in Mbps (-1 for unlimited) |
            | `--data-dir, -d` | ./data | Directory for keys and state |
            | `-v` | - | Verbose output (`-vv` for debug) |

            ### Verify Downloads

            ```bash
            curl -L -o checksums.txt https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/checksums.txt
            sha256sum -c checksums.txt --ignore-missing
            ```
